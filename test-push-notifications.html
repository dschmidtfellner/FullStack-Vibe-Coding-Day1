<!DOCTYPE html>
<html>
<head>
    <title>Cross-Firebase Push Notification Testing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <h1>Cross-Firebase Push Notification Testing</h1>
    <p>Test suite for the cross-Firebase push notification system implementation</p>

    <!-- Configuration Section -->
    <div class="section">
        <h2>Configuration</h2>
        <div class="form-group">
            <label for="baseUrl">Firebase Functions Base URL:</label>
            <input type="text" id="baseUrl" value="https://us-central1-doulaconnect-messaging.cloudfunctions.net" />
        </div>
        <div class="status" id="configStatus">
            Click "Test Configuration" to verify the connection
        </div>
        <button onclick="testConfiguration()">Test Configuration</button>
    </div>

    <!-- Test Push Notification -->
    <div class="section">
        <h2>Test Push Notification</h2>
        <div class="form-group">
            <label for="testUserId">User ID (for token lookup):</label>
            <input type="text" id="testUserId" placeholder="Enter user ID from old Firebase project" />
        </div>
        <div class="form-group">
            <label for="testFcmToken">FCM Token (direct token test):</label>
            <input type="text" id="testFcmToken" placeholder="Enter FCM token directly (optional)" />
        </div>
        <div class="form-group">
            <label for="testTitle">Notification Title:</label>
            <input type="text" id="testTitle" value="Test Notification" />
        </div>
        <div class="form-group">
            <label for="testBody">Notification Body:</label>
            <textarea id="testBody" rows="3">This is a test notification from the cross-Firebase messaging system</textarea>
        </div>
        <button onclick="testPushNotification()">Send Test Notification</button>
        <div id="testResult"></div>
    </div>

    <!-- User Mapping Management -->
    <div class="section">
        <h2>User Mapping Management</h2>
        <div class="form-group">
            <label for="oldUserId">Old Firebase User ID:</label>
            <input type="text" id="oldUserId" placeholder="User ID from old Firebase project" />
        </div>
        <div class="form-group">
            <label for="newUserId">New Firebase User ID:</label>
            <input type="text" id="newUserId" placeholder="User ID from new Firebase project" />
        </div>
        <div class="form-group">
            <label for="userEmail">Email (optional):</label>
            <input type="email" id="userEmail" placeholder="user@example.com" />
        </div>
        <div class="form-group">
            <label for="userName">Name (optional):</label>
            <input type="text" id="userName" placeholder="User Name" />
        </div>
        <button onclick="createUserMapping()">Create/Update Mapping</button>
        <button onclick="getUserMapping()">Get Mapping</button>
        <div id="mappingResult"></div>
    </div>

    <!-- FCM Token Sync -->
    <div class="section">
        <h2>FCM Token Sync</h2>
        <div class="form-group">
            <label for="syncUserId">User ID:</label>
            <input type="text" id="syncUserId" placeholder="User ID" />
        </div>
        <div class="form-group">
            <label for="syncFcmToken">FCM Token:</label>
            <input type="text" id="syncFcmToken" placeholder="FCM Token to sync" />
        </div>
        <button onclick="syncFCMToken()">Sync FCM Token</button>
        <div id="syncResult"></div>
    </div>

    <!-- System Status -->
    <div class="section">
        <h2>System Status</h2>
        <button onclick="getSystemStatus()">Check System Status</button>
        <div id="statusResult"></div>
    </div>

    <!-- FCM Token Storage Explorer -->
    <div class="section">
        <h2>FCM Token Storage Explorer</h2>
        <p>Explore how FCM tokens are stored in your old Firebase projects</p>
        <div class="form-group">
            <label>Select Project to Explore:</label>
            <select id="exploreProject">
                <option value="rested">Rested (rested-bubble)</option>
                <option value="doulaConnect">DoulaConnect (doulaconnect-119a4)</option>
            </select>
        </div>
        <button onclick="exploreFCMStorage()">Explore FCM Token Storage</button>
        <div id="exploreResult"></div>
    </div>

    <script>
        let baseUrl = '';

        function updateBaseUrl() {
            baseUrl = document.getElementById('baseUrl').value;
        }

        function showResult(elementId, result, isError = false) {
            const element = document.getElementById(elementId);
            element.className = `result ${isError ? 'error' : 'success'}`;
            element.textContent = JSON.stringify(result, null, 2);
        }

        function showInfo(elementId, message) {
            const element = document.getElementById(elementId);
            element.className = 'result info';
            element.textContent = message;
        }

        async function testConfiguration() {
            updateBaseUrl();
            const statusEl = document.getElementById('configStatus');
            
            try {
                statusEl.textContent = 'Testing connection...';
                const response = await fetch(`${baseUrl}/testPushNotification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fcmToken: 'test-token-for-config-check',
                        title: 'Config Test',
                        body: 'Configuration test - this should fail gracefully'
                    })
                });
                
                if (response.ok) {
                    statusEl.className = 'status success';
                    statusEl.textContent = '✅ Connection successful - Firebase Functions are accessible';
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = `❌ Connection failed: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `❌ Connection error: ${error.message}`;
            }
        }

        async function testPushNotification() {
            updateBaseUrl();
            const userId = document.getElementById('testUserId').value;
            const fcmToken = document.getElementById('testFcmToken').value;
            const title = document.getElementById('testTitle').value;
            const body = document.getElementById('testBody').value;

            if (!userId && !fcmToken) {
                showResult('testResult', { error: 'Must provide either User ID or FCM Token' }, true);
                return;
            }

            try {
                showInfo('testResult', 'Sending test notification...');
                
                const response = await fetch(`${baseUrl}/testPushNotification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId || undefined,
                        fcmToken: fcmToken || undefined,
                        title,
                        body
                    })
                });

                const result = await response.json();
                showResult('testResult', result, !response.ok);
            } catch (error) {
                showResult('testResult', { error: error.message }, true);
            }
        }

        async function createUserMapping() {
            updateBaseUrl();
            const oldUserId = document.getElementById('oldUserId').value;
            const newUserId = document.getElementById('newUserId').value;
            const email = document.getElementById('userEmail').value;
            const name = document.getElementById('userName').value;

            if (!oldUserId || !newUserId) {
                showResult('mappingResult', { error: 'Old User ID and New User ID are required' }, true);
                return;
            }

            try {
                showInfo('mappingResult', 'Creating user mapping...');
                
                const response = await fetch(`${baseUrl}/createUserMapping`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        oldUserId,
                        newUserId,
                        email: email || undefined,
                        name: name || undefined
                    })
                });

                const result = await response.json();
                showResult('mappingResult', result, !response.ok);
            } catch (error) {
                showResult('mappingResult', { error: error.message }, true);
            }
        }

        async function getUserMapping() {
            updateBaseUrl();
            const oldUserId = document.getElementById('oldUserId').value;
            const newUserId = document.getElementById('newUserId').value;
            const email = document.getElementById('userEmail').value;

            if (!oldUserId && !newUserId && !email) {
                showResult('mappingResult', { error: 'Must provide at least one identifier' }, true);
                return;
            }

            try {
                showInfo('mappingResult', 'Getting user mapping...');
                
                const response = await fetch(`${baseUrl}/getUserMapping`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        oldUserId: oldUserId || undefined,
                        newUserId: newUserId || undefined,
                        email: email || undefined
                    })
                });

                const result = await response.json();
                showResult('mappingResult', result, !response.ok);
            } catch (error) {
                showResult('mappingResult', { error: error.message }, true);
            }
        }

        async function syncFCMToken() {
            updateBaseUrl();
            const userId = document.getElementById('syncUserId').value;
            const fcmToken = document.getElementById('syncFcmToken').value;

            if (!userId || !fcmToken) {
                showResult('syncResult', { error: 'User ID and FCM Token are required' }, true);
                return;
            }

            try {
                showInfo('syncResult', 'Syncing FCM token...');
                
                const response = await fetch(`${baseUrl}/syncFCMTokens`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId,
                        fcmToken
                    })
                });

                const result = await response.json();
                showResult('syncResult', result, !response.ok);
            } catch (error) {
                showResult('syncResult', { error: error.message }, true);
            }
        }

        async function getSystemStatus() {
            updateBaseUrl();
            
            try {
                showInfo('statusResult', 'Checking system status...');
                
                // Test with a dummy request to check if old Firebase is configured
                const response = await fetch(`${baseUrl}/testPushNotification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fcmToken: 'status-check-token',
                        title: 'Status Check',
                        body: 'System status check'
                    })
                });

                const result = await response.json();
                
                const status = {
                    functionsAvailable: response.ok,
                    oldFirebaseConfigured: result.oldFirebaseConfigured,
                    timestamp: new Date().toISOString(),
                    response: result
                };

                showResult('statusResult', status, !response.ok);
            } catch (error) {
                showResult('statusResult', { 
                    error: error.message,
                    functionsAvailable: false,
                    timestamp: new Date().toISOString()
                }, true);
            }
        }

        async function exploreFCMStorage() {
            updateBaseUrl();
            const project = document.getElementById('exploreProject').value;
            
            try {
                showInfo('exploreResult', `Exploring ${project} FCM token storage...`);
                
                const response = await fetch(`${baseUrl}/exploreFCMTokenStorage?project=${project}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                showResult('exploreResult', result, !response.ok);
            } catch (error) {
                showResult('exploreResult', { error: error.message }, true);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateBaseUrl();
        });
    </script>
</body>
</html>